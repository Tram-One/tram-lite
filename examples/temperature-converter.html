<template is="component-definition">
	<temperature-converter f="" c="">
		<label>F <input id="f" oninput="updateRootAttr('f', event)" value="${'f'}" /></label><br />
		<label>C <input id="c" oninput="updateRootAttr('c', event)" value="${'c'}" /></label>
		<p>${'message'}</p>

		<script is="component-effect" dependencies="c">
			const c = this.getAttribute('c');
			const newF = calcFahrenheit(c);
			if (c && !isReflectiveUpdate(this)) {
				this.setAttribute('f', newF);
			}
		</script>
		<script is="component-effect" dependencies="f">
			const f = this.getAttribute('f');
			const newC = calcCelsius(f);
			if (f) {
				this.setAttribute('c', newC);
			}
		</script>
		<script is="component-effect" dependencies="c f">
			if (!this.getAttribute('f') || !this.getAttribute('c')) {
				// if either of these are undefined, don't put an update message up
				return;
			}

			this.setAttribute('message', 'Updated!');
			const timeoutId = setTimeout(() => {
				if (this.timeoutId === timeoutId) {
					this.setAttribute('message', '');
				}
			}, 5000);
			this.timeoutId = timeoutId;
		</script>
	</temperature-converter>
</template>

<script>
	function calcCelsius(f) {
		return ((f - 32) * (5 / 9)).toFixed(0);
	}

	function calcFahrenheit(c) {
		return (c * (9 / 5) + 32).toFixed(0);
	}

	function isReflectiveUpdate(temperatureConverter) {
		const f = temperatureConverter.getAttribute('f');
		const c = temperatureConverter.getAttribute('c');
		// if this celsius or fahrenheit value would generate the other, don't update
		// this is indicative of an update triggered by another update!
		// this can happen because multiple Fahrenheit values map to the same (truncated) celsius value
		// e.g. 19F and 20F both map to -7C
		return calcFahrenheit(calcCelsius(f)) === calcFahrenheit(c);
	}
</script>
